!-- 1. templates/orders/receipt.html - –í–ò–ó–£–ê–õ–¨–ù–´–ô –ß–ï–ö -->
{% extends "base.html" %}

{% block title %}–ß–µ–∫ ‚Ññ{{ order.id }}{% endblock %}

{% block extra_css %}
<style>
    @media print {
        .no-print { display: none !important; }
        .receipt-container {
            box-shadow: none !important;
            border: 1px solid #000 !important;
            max-width: 350px !important;
            margin: 0 auto !important;
        }
        .btn { display: none !important; }
        body { font-size: 12px; }
    }

    .receipt-container {
        max-width: 400px;
        margin: 0 auto;
        font-family: 'Courier New', monospace;
        background: white;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
        border-radius: 10px;
        overflow: hidden;
    }

    .receipt-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-align: center;
        padding: 20px;
    }

    .receipt-body {
        padding: 20px;
    }

    .dashed-line {
        border-top: 2px dashed #ccc;
        margin: 15px 0;
    }

    .receipt-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .receipt-total {
        font-weight: bold;
        font-size: 16px;
        border-top: 2px solid #333;
        padding-top: 10px;
        margin-top: 15px;
    }

    .qr-code {
        text-align: center;
        margin: 20px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="text-center mb-4 no-print">
        <h2><i class="fas fa-receipt me-2 text-primary"></i>–ß–µ–∫ –∑–∞–∫–∞–∑–∞</h2>
        <div class="btn-group" role="group">
            <button onclick="window.print()" class="btn btn-primary">
                <i class="fas fa-print me-2"></i>–ü–µ—á–∞—Ç—å
            </button>
            <a href="{% url 'orders:detail' order.id %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>–ö –∑–∞–∫–∞–∑—É
            </a>
            <button onclick="downloadPDF()" class="btn btn-success">
                <i class="fas fa-download me-2"></i>PDF
            </button>
        </div>
    </div>

    <div class="receipt-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–µ–∫–∞ -->
        <div class="receipt-header">
            <h3 class="mb-1">üçΩÔ∏è –ù–ê–íAT</h3>
            <p class="mb-0">–°–µ—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤</p>
            <small>{{ order.restaurant.name }}</small>
        </div>

        <!-- –¢–µ–ª–æ —á–µ–∫–∞ -->
        <div class="receipt-body">
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ -->
            <div class="text-center mb-3">
                <h5>–ß–ï–ö ‚Ññ{{ order.id }}</h5>
                <p class="mb-1">{{ order.created_at|date:"d.m.Y H:i" }}</p>
                {% if order.table_number %}
                <p class="mb-0">–°—Ç–æ–ª ‚Ññ{{ order.table_number }}</p>
                {% endif %}
            </div>

            <div class="dashed-line"></div>

            <!-- –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞ -->
            {% for item in order.items.all %}
            <div class="receipt-row">
                <div class="flex-grow-1">
                    <div>{{ item.menu_item.name }}</div>
                    <small class="text-muted">
                        {{ item.quantity }} √ó {{ item.price_at_moment|floatformat:0 }} —Å–æ–º
                    </small>
                </div>
                <div class="text-end">
                    <strong data-price="{{ item.get_cost }}">{{ item.get_cost|floatformat:0 }} —Å–æ–º</strong>
                </div>
            </div>
            {% endfor %}

            <div class="dashed-line"></div>

            <!-- –ò—Ç–æ–≥–æ -->
            <div class="receipt-row receipt-total">
                <div>–ò–¢–û–ì–û:</div>
                <div data-price="{{ order.total_price }}">{{ order.total_price|floatformat:0 }} –°–û–ú</div>
            </div>

            <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="text-center mt-4">
                <small class="text-muted">
                    –û–±—Å–ª—É–∂–∏–ª: {{ order.created_by.get_full_name|default:order.created_by.username }}<br>
                    –°—Ç–∞—Ç—É—Å: {{ order.get_status_display }}<br>
                    {% if order.ingredients_processed %}
                    ‚úÖ –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã —Å–ø–∏—Å–∞–Ω—ã
                    {% else %}
                    ‚è≥ –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –Ω–µ —Å–ø–∏—Å–∞–Ω—ã
                    {% endif %}
                </small>
            </div>

            <!-- QR –∫–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
            <div class="qr-code">
                <div id="qrcode"></div>
                <small class="text-muted d-block mt-2">
                    –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–∫–∞–∑–∞
                </small>
            </div>

            <div class="dashed-line"></div>

            <!-- –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å -->
            <div class="text-center">
                <p class="mb-1"><strong>–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –∑–∞–∫–∞–∑!</strong></p>
                <small class="text-muted">
                    –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –µ—â–µ!<br>
                    {{ order.restaurant.address }}<br>
                    {{ order.restaurant.phone_number }}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<script>
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞
document.addEventListener('DOMContentLoaded', function() {
    const orderUrl = window.location.origin + "{% url 'orders:detail' order.id %}";

    QRCode.toCanvas(document.getElementById('qrcode'), orderUrl, {
        width: 120,
        height: 120,
        margin: 2
    }, function (error) {
        if (error) console.error(error);
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è PDF (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
function downloadPDF() {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º browser print to PDF –∏–ª–∏ –º–æ–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π
    window.print();
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª—é—Ç—ã
document.addEventListener('DOMContentLoaded', function() {
    function formatSom(amount) {
        return Math.round(amount).toLocaleString('ru-KG') + ' —Å–æ–º';
    }

    const priceElements = document.querySelectorAll('[data-price]');
    priceElements.forEach(element => {
        const price = parseFloat(element.dataset.price);
        if (price > 0) {
            element.textContent = formatSom(price);
        }
    });
});
</script>
{% endblock %}